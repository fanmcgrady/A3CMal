import array
import numpy
import os
import p

# 用于从.bytes文件以及.asm文件获取图像特征
def get_feature(data_set='train', data_type='bytes'):
    files = os.listdir(data_set)
    with open('%s_%s_image.csv' % (data_set, data_type), 'wb') as f:
        f.write(b'Id,%s\n' % b','.join([str.encode('%s_%i' % (data_type, x)) for x in range(1000)]))
        for cc, x in enumerate(files):
            # 选择bytes文件还是asm文件
            # if data_type != x.split('.')[-1]:
            #     continue
            if data_type not in x:
                continue
            # 获取文件名
            # file_id = x.split('.')[0]
            file_id = x.replace('.bytes', '')
            tmp = read_image(data_set + '/' + x)
            f.write(b'%s,%s\n' % (str.encode(file_id), b','.join(v for v in tmp)))
            # print "finish..." + file_id


def read_image(filename):
    f = open(filename, 'rb')
    # 获取文件的字节数
    ln = os.path.getsize(filename)  # length of file in bytes
    width = 256
    rem = ln % width
    a = array.array("B")  # uint8 array
    a.fromfile(f, ln - rem)
    f.close()
    g = numpy.reshape(a, (int(len(a) / width), width))
    g = numpy.uint8(g)
    # g.resize的写法被舍弃了
    g = numpy.resize(g, (1000,))
    return list(g)


if __name__ == '__main__':
    get_feature(data_set = p.TRAIN_PATH, data_type = 'bytes')
    # get_feature(data_set=p.TRAIN_PATH, data_type='asm')
    # get_feature(data_set = 'test', data_type = 'bytes')
    # get_feature(data_set=p.TEST_PATH, data_type='asm')
    print('DONE bytes image features!')
    # print('DONE asm image features!')
